<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <title>CatTree Lite</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.8/themes/default/style.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree-bootstrap-theme@1.0.1/src/themes/proton/style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
  <style type='text/css'>
  button{
    border-radius:5px;
    background-color:teal;
    color:white;
  }
  </style>
  <script>

    $( document ).ready(function() {
      //console.log( "ready!" );
      var treestructurejson_url = getUrlParameter('treestructurejson_url');
      if(treestructurejson_url){
        //console.log(treestructurejson_url);
          var TreeStructure = {};
          $.ajax({
                 url: treestructurejson_url,
                 type: "GET",

                 success: function(data) {
                    TreeStructure = data;
                    //console.log(JSON.stringify(data));
                 },
                 error : function(error) {
                    alert('Error');
                    //console.log("no good "+JSON.stringify(error));
                 }
          });
          var option = {};
          option.id = 0;
          initialTreefromTreeStructure(TreeStructure, option);
      }

    });

    function getUrlParameter(sParam) {
          var sPageURL = window.location.search.substring(1),
              sURLVariables = sPageURL.split('&'),
              sParameterName,
              i;

          for (i = 0; i < sURLVariables.length; i++) {
              sParameterName = sURLVariables[i].split('=');

              if (sParameterName[0] === sParam) {
                  return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
              }
          }
    }

    function initialTreefromTreeStructure(TreeStructure, option){
      if(option.theme == 'original'){

        $('#CatTree' + option.id).jstree({ 'core' : {
          'data' : TreeStructure
          }
        });

      }
      else if(option.theme == 'dark'){

        $('#CatTree' + option.id).jstree({ 'core' : {
          'data' : TreeStructure,
          'themes': {
                  'responsive': true
              }
          }
        });


      }
      else if(option.theme == 'proton'){

        $('#CatTree' + option.id).jstree({ 'core' : {
          'data' : TreeStructure,
          'themes': {
                  'name': 'proton',
                  'responsive': true
              }
          }
        });

      }
      else{

        $('#CatTree' + option.id).jstree({ 'core' : {
          'data' : TreeStructure,
          'themes': {
                  'name': 'proton',
                  'responsive': true
              }
          }
        });
      }


      $('#CatTree' + option.id).on("changed.jstree", function (e, data) {
        var i, j;
        for(i = 0, j = data.selected.length; i < j; i++)  {
          //console.log(data);
          if(data.node.original.url){
            window.open(data.node.original.url);
          }else{
            if(option.onclick){
              eval('onclickFun = ' + decodeURI(option.onclick));
              onclickFun(data.node.original, TreeStructure);
            }
          }

        }
      });

      openTreeTerm(TreeStructure, option);

    }

    function initialTreefromDocuSkySearch(DocuSkySearch, option){
        //console.log(DocuSkySearch);
        var TreeStructure = [];
        if(option.title){
          TreeStructure[0] = {'id': '0', 'parent': '#', 'text': option.title};
        }else{
          TreeStructure[0] = {'id': '0', 'parent': '#', 'text': 'CatTree Lite'};
        }

        var TreeStructureAppendInfo = {'id':1};
        for(index in DocuSkySearch){
          //console.log(DocuSkySearch[index].cnt);
          //console.log(DocuSkySearch[index]);
          var splitArr = DocuSkySearch[index].cue.split('/');
          var cnt = DocuSkySearch[index].cnt;
          for(indexNode in splitArr){
            //console.log(DocuSkySearch[index].cue);
            //console.log(splitArr);
            if(!isNodeNameinTreeStructure(indexNode,splitArr,TreeStructure)){
              //console.log(DocuSkySearch[index].cue.split('/')[indexNode]);
              //console.log(splitArr[indexNode]);
              //console.log(splitArr);
              //console.log(cnt);
              //console.log(TreeStructure);
              addNodeNametoTreeStructure(indexNode,cnt,splitArr,TreeStructure,TreeStructureAppendInfo);
            }
          }
        }
        //console.log(TreeStructure);
        initialTreefromTreeStructure(TreeStructure, option);

    }

    function isNodeNameinTreeStructure(indexNode,splitArr,TreeStructure){
      if(indexNode==0){
        for(index in TreeStructure){
          if(TreeStructure[index].text == splitArr[indexNode] && TreeStructure[index].parent==0){
            return true;
          }
        }
        return false;
      }else{
        for(index in TreeStructure){
          if(TreeStructure[index].text == splitArr[indexNode]){
            //splitArr[indexNode-1] = TreeStructure[TreeStructure[index].parent].text;
            //splitArr[indexNode-2] = TreeStructure[TreeStructure[index].parent].text;
            var parentID = TreeStructure[index].parent;
            for(var i = indexNode-1; i>=0; i--){
              if(splitArr[i]==TreeStructure[parentID].text){
                parentID = TreeStructure[parentID].parent;
              }else{
                return false;
              }
            }
            if(parentID==0){
              return true;
            }
          }
        }
        return false;
      }

    }
    function getParentID(indexNode,splitArr,TreeStructure){
      if(indexNode==0){
        return 0;
      }else{
        var parentID = 0;
        var grandID = -1;
        for(index in TreeStructure){
          if(TreeStructure[index].text == splitArr[indexNode-1]){
            //splitArr[indexNode-1] = TreeStructure[TreeStructure[index].parent].text;
            //splitArr[indexNode-2] = TreeStructure[TreeStructure[index].parent].text;
            parentID = TreeStructure[index].id;
            grandID = TreeStructure[index].id;
            if(splitArr.length>2){
              for(var i = indexNode-2; i>=0; i--){
                if(splitArr[i]==TreeStructure[TreeStructure[grandID].parent].text){
                  grandID = TreeStructure[grandID].parent;
                }
              }
            }
            /*if(TreeStructure[grandID].parent==0){
              return parentID;
            }*/

          }
        }
        return parentID;
      }

    }
    function addNodeNametoTreeStructure(indexNode,count,splitArr,TreeStructure,TreeStructureAppendInfo){
      if(indexNode==0 && splitArr.length==1 && count!=0){
        TreeStructure[TreeStructureAppendInfo.id] = {'id': TreeStructureAppendInfo.id, 'parent': '0', 'text': splitArr[indexNode]+`(${count}件)`};
      }else if(indexNode==splitArr.length-1){
        var ParentID = getParentID(indexNode,splitArr,TreeStructure);
        TreeStructure[TreeStructureAppendInfo.id] = {'id': TreeStructureAppendInfo.id, 'parent': ParentID, 'text': splitArr[indexNode]+`(${count}件)`};
      }else{
        var ParentID = getParentID(indexNode,splitArr,TreeStructure);
        TreeStructure[TreeStructureAppendInfo.id] = {'id': TreeStructureAppendInfo.id, 'parent': ParentID, 'text': splitArr[indexNode]};
      }
      TreeStructureAppendInfo.id += 1;
    }

    function initialTreefromTreeStructureandDocuSkySearch(TreeStructure, DocuSkySearch, option){
      var TreeStructurewithCNT = TreeStructure;
      for(index in DocuSkySearch){
        var splitArr = DocuSkySearch[index].cue.split('/');
        var cnt = DocuSkySearch[index].cnt;
        var ParentID = getParentID(splitArr.length-1,splitArr,TreeStructurewithCNT);
        for(indexStructure in TreeStructurewithCNT){
          if(TreeStructurewithCNT[indexStructure].text==splitArr[splitArr.length-1] && ParentID==TreeStructurewithCNT[indexStructure].parent){
            if(option.quantifierterm){
              TreeStructurewithCNT[indexStructure].text += `(${cnt}${option.quantifierterm})`;
            }else{
              TreeStructurewithCNT[indexStructure].text += `(${cnt}件)`;
            }

          }
        }
      }
      initialTreefromTreeStructure(TreeStructurewithCNT, option);

    }

    function openTreeRoot(index){

      $("#CatTree" + index).on('loaded.jstree', function() {
        $("#CatTree" + index).jstree("open_node", $("#0"));
      });
    }

    function openTreeAll(index){
      $("#CatTree" + index).on('loaded.jstree', function() {
        $("#CatTree" + index).jstree('open_all');
      });
    }

    function openTreeTerm(TreeStructure, option){
      var openNodeArr = [];
      if(option.openTreeTerm){
        for(index in TreeStructure){
            if(TreeStructure[index].text.includes(option.openTreeTerm)){
              var id = index;
              while(id != '#'){
                openNodeArr.push(id);
                id = TreeStructure[id].parent;
              }

            }
        }

        $("#CatTree" + option.id).on('loaded.jstree', function() {
          for( var i = openNodeArr.length; i >= 0; i--){
            $("#CatTree" + option.id).jstree("open_node", $("#"+openNodeArr[i]));
          }

        });
        //console.log(openNodeArr);
      }


    }

    function receiveMessage( event ) {
  		//console.log( 'receiveMessageData', event.data );
      if(event.data.length==0){
        alert('Error No Tree Data');
        return;
      }


      var buttonHTML = '';
      var TreeHTML = '';
      for(index in event.data){

        var receiveData = event.data[index];
        //console.log(receiveData);
        if(receiveData.option){
          receiveData.option.id = index;
        }else{
          receiveData.option = {};
          receiveData.option.id = index;
        }

        if(receiveData.option.title){
          buttonHTML += `<button class="controlBtn" type="button" bt="${index}">${receiveData.option.title}</button>`;
        }
        else{
          buttonHTML += `<button class="controlBtn" type="button" bt="${index}">CatTree Lite ${index}</button>`;
        }

        TreeHTML += `<div class="tree" id="CatTree${index}"></div>`;

      }

      $('body').append(buttonHTML);
      $('body').append(TreeHTML);

      for(index in event.data){

        var receiveData = event.data[index];
        //console.log(receiveData);
        if(receiveData.option){
          receiveData.option.id = index;
        }else{
          receiveData.option = {};
          receiveData.option.id = index;
        }

        if(receiveData.DocuSkySearch && receiveData.TreeStructure){
            initialTreefromTreeStructureandDocuSkySearch(receiveData.TreeStructure,receiveData.DocuSkySearch, receiveData.option);
        }else if(receiveData.DocuSkySearch){
            initialTreefromDocuSkySearch(receiveData.DocuSkySearch, receiveData.option);
        }else if(receiveData.TreeStructure){
            initialTreefromTreeStructure(receiveData.TreeStructure, receiveData.option);
        }else{
          alert('Error No Tree Data');
        }

        openTreeRoot(receiveData.option.id);
        if(receiveData.option.openTreeAll){
          openTreeAll(receiveData.option.id);
        }

      }

      $(".tree").hide();
      $(".controlBtn").hide();
      if(event.data.length == 1){
        $(".tree").show();
      }else{
        $(".controlBtn").show();
        $("#CatTree0").show();
        $(".controlBtn").click(function(){
          var getIndex = $(this).attr('bt');
          $(".tree").hide();
          $("#CatTree"+getIndex).show();
        });

      }
	 }
   window.addEventListener("message", receiveMessage, false);
  </script>

</head>
<body>
</body>

</html>
