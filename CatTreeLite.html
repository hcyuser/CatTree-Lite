<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <title>CatTree Lite</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.8/themes/default/style.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree-bootstrap-theme@1.0.1/src/themes/proton/style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/css/bootstrap.css">

  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.18/css/dataTables.bootstrap4.min.css"/>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.18/js/dataTables.bootstrap4.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.2/xlsx.full.min.js"></script>

  <style type='text/css'>
  button{
    border-radius:5px;
    background-color:teal;
    color:white;
    padding: 1.5px 1.5px;
  }
  </style>
  <script>
    var xlsxInJSON;
    $( document ).ready(function() {
      //console.log( "ready!" );
      $('#independentToolModal').modal('show');
      var url = getUrlParameter('url');
      if(url){

        if(url.includes('.json')){

          var TreeStructures = [];
          $.ajax({
                 url: url,
                 type: "GET",

                 success: function(data) {
                    TreeStructures = data;
                    //console.log(JSON.stringify(data));
                 },
                 error : function(error) {
                    alert('Error');
                    //console.log("no good "+JSON.stringify(error));
                 }
          });

          var event = {};
          event.data = TreeStructures;
          receiveMessage(event);

        }
      }

    });

    function getUrlParameter(sParam) {
          var sPageURL = window.location.search.substring(1),
              sURLVariables = sPageURL.split('&'),
              sParameterName,
              i;

          for (i = 0; i < sURLVariables.length; i++) {
              sParameterName = sURLVariables[i].split('=');

              if (sParameterName[0] === sParam) {
                  return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
              }
          }
    }

    function xlsxUpload(e) {
              //取得上傳第一個檔案
              //var files = e.target.files;
              var f = e.files[0];
              //使用FileReader讀檔
              var reader = new FileReader();
              //檔案名稱
              var name = f.name;

              //onload觸發事件
              reader.onload = function (e) {

                  //對象內資料
                  var data = e.target.result;

                  //讀取xlsx資料
                  xlsxInJSON = readxlsx(data, 'json');
                  //var retcsv = readxlsx(data, 'csv');
                  $('#independentToolModal').modal('hide');

              };
              //以BinaryString讀入
              reader.readAsBinaryString(f);
    }
    function readxlsx(inpdata, fmt) {
            //讀取xlsx檔

            //參數
            //inpdata為由input file讀入之data
            //fmt為讀取格式，可有"json"或"csv"，csv格式之分欄符號為逗號，分行符號為[\n]

            //說明
            //所使用函式可參考js-xlsx的GitHub文件[https://github.com/SheetJS/js-xlsx]


            //to_json
            function to_json(workbook) {
                var result = {};
                workbook.SheetNames.forEach(function (sheetName) {
                    var roa = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
                    if (roa.length > 0) {
                        result[sheetName] = roa;
                    }
                });
                return result;
            }


            //to_csv
            function to_csv(workbook) {
                var result = [];
                workbook.SheetNames.forEach(function(sheetName) {
                    var csv = XLSX.utils.sheet_to_csv(workbook.Sheets[sheetName]);
                    if(csv.length > 0){
                        result.push('SHEET: ' + sheetName);
                        result.push('\n');
                        result.push(csv);
                    }
                });
                return result;
            }


            //讀檔
            var workbook = XLSX.read(inpdata, { type: 'binary' });


            //轉為json物件回傳
            if (fmt === 'json') {
                return to_json(workbook);
            }
            else {
                return to_csv(workbook);
            }


    }

    function initialTreefromTreeStructure(receiveData){
      if(receiveData.theme == 'original'){

        $('#CatTree' + receiveData.id).jstree({
          'core' : {
            'data' : receiveData.TreeStructure
          },
          'plugins': ['search'],
          'search': {
              'show_only_matches': true,
              'show_only_matches_children': true
          }

        });

      }
      else if(receiveData.theme == 'dark'){

        $('#CatTree' + receiveData.id).jstree({
          'core' : {
              'data' : receiveData.TreeStructure,
              'themes': {
                      'responsive': true
                  }
          },
          'plugins': ['search'],
          'search': {
              'show_only_matches': true,
              'show_only_matches_children': true
          }

        });


      }
      else if(receiveData.theme == 'proton'){

        $('#CatTree' + receiveData.id).jstree({
          'core' : {
                'data' : receiveData.TreeStructure,
                'themes': {
                        'name': 'proton',
                        'responsive': true
                    }
          },
          'plugins': ['search'],
          'search': {
              'show_only_matches': true,
              'show_only_matches_children': true
          }

        });

      }
      else{

        $('#CatTree' + receiveData.id).jstree({

          'core' : {
              'data' : receiveData.TreeStructure,
              'themes': {
                      'name': 'proton',
                      'responsive': true
              }
          },
          'plugins': ['search'],
          'search': {
              'show_only_matches': true,
              'show_only_matches_children': true
          }

        });

      }



      $('#CatTree' + receiveData.id).on("changed.jstree", function (e, data) {
        var i, j;
        for(i = 0, j = data.selected.length; i < j; i++)  {
          //console.log(data);
          if(data.node.original.url){
            window.open(data.node.original.url);
          }

        }
      });


      openTreeTerm(receiveData);

    }

    function initialTreefromDocuSkySearch(receiveData){
        //console.log(DocuSkySearch);
        var TreeStructure = [];
        if(receiveData.title){
          TreeStructure[0] = {'id': '0', 'parent': '#', 'text': receiveData.title};
        }else{
          TreeStructure[0] = {'id': '0', 'parent': '#', 'text': 'CatTree Lite'};
        }

        var TreeStructureAppendInfo = {'id':1};
        for(index in receiveData.DocuSkySearch){
          //console.log(DocuSkySearch[index].cnt);
          //console.log(DocuSkySearch[index]);
          var splitArr = receiveData.DocuSkySearch[index].cue.split('/');
          var cnt = receiveData.DocuSkySearch[index].cnt;
          for(indexNode in splitArr){
            //console.log(DocuSkySearch[index].cue);
            //console.log(splitArr);
            if(!isNodeNameinTreeStructure(indexNode,splitArr,TreeStructure)){
              //console.log(DocuSkySearch[index].cue.split('/')[indexNode]);
              //console.log(splitArr[indexNode]);
              //console.log(splitArr);
              //console.log(cnt);
              //console.log(TreeStructure);
              addNodeNametoTreeStructure(indexNode,cnt,splitArr,TreeStructure,TreeStructureAppendInfo, receiveData);
            }
          }
        }
        //console.log(TreeStructure);
        receiveData.TreeStructure = TreeStructure;
        initialTreefromTreeStructure(receiveData);

    }

    function isNodeNameinTreeStructure(indexNode,splitArr,TreeStructure){
      if(indexNode==0){
        for(index in TreeStructure){
          if(TreeStructure[index].text == splitArr[indexNode] && TreeStructure[index].parent==0){
            return true;
          }
        }
        return false;
      }else{
        for(index in TreeStructure){
          if(TreeStructure[index].text == splitArr[indexNode]){
            //splitArr[indexNode-1] = TreeStructure[TreeStructure[index].parent].text;
            //splitArr[indexNode-2] = TreeStructure[TreeStructure[index].parent].text;
            var parentID = TreeStructure[index].parent;
            for(var i = indexNode-1; i>=0; i--){
              if(splitArr[i]==TreeStructure[parentID].text){
                parentID = TreeStructure[parentID].parent;
              }else{
                return false;
              }
            }
            if(parentID==0){
              return true;
            }
          }
        }
        return false;
      }

    }
    function getParentID(indexNode,splitArr,TreeStructure){
      if(indexNode==0){
        return 0;
      }else{
        var parentID = 0;
        var grandID = -1;
        for(index in TreeStructure){
          if(TreeStructure[index].text == splitArr[indexNode-1]){
            //splitArr[indexNode-1] = TreeStructure[TreeStructure[index].parent].text;
            //splitArr[indexNode-2] = TreeStructure[TreeStructure[index].parent].text;
            parentID = TreeStructure[index].id;
            grandID = TreeStructure[index].id;
            if(splitArr.length>2){
              for(var i = indexNode-2; i>=0; i--){
                if(splitArr[i]==TreeStructure[TreeStructure[grandID].parent].text){
                  grandID = TreeStructure[grandID].parent;
                }
              }
            }
            /*if(TreeStructure[grandID].parent==0){
              return parentID;
            }*/

          }
        }
        return parentID;
      }

    }
    function addNodeNametoTreeStructure(indexNode,count,splitArr,TreeStructure,TreeStructureAppendInfo, receiveData){
      if(indexNode==0 && splitArr.length==1 && count!=0){
        if(receiveData.quantifierTerm){
          TreeStructure[TreeStructureAppendInfo.id] = {'id': TreeStructureAppendInfo.id, 'parent': '0', 'text': splitArr[indexNode]+`(${count}${receiveData.quantifierTerm})`};
        }else{
          TreeStructure[TreeStructureAppendInfo.id] = {'id': TreeStructureAppendInfo.id, 'parent': '0', 'text': splitArr[indexNode]+`(${count}件)`};
        }

      }else if(indexNode==splitArr.length-1){
        var ParentID = getParentID(indexNode,splitArr,TreeStructure);
        if(receiveData.quantifierTerm){
          TreeStructure[TreeStructureAppendInfo.id] = {'id': TreeStructureAppendInfo.id, 'parent': ParentID, 'text': splitArr[indexNode]+`(${count}${receiveData.quantifierTerm})`};
        }else{
          TreeStructure[TreeStructureAppendInfo.id] = {'id': TreeStructureAppendInfo.id, 'parent': ParentID, 'text': splitArr[indexNode]+`(${count}件)`};
        }

      }else{
        var ParentID = getParentID(indexNode,splitArr,TreeStructure);
        TreeStructure[TreeStructureAppendInfo.id] = {'id': TreeStructureAppendInfo.id, 'parent': ParentID, 'text': splitArr[indexNode]};
      }
      TreeStructureAppendInfo.id += 1;
    }

    function initialTreefromTreeStructureandDocuSkySearch(receiveData){
      //console.log(TreeStructure);
      var TreeStructurewithCNT = receiveData.TreeStructure;
      for(index in receiveData.DocuSkySearch){
        var splitArr = receiveData.DocuSkySearch[index].cue.split('/');
        var cnt = receiveData.DocuSkySearch[index].cnt;
        var ParentID = getParentID(splitArr.length-1,splitArr,TreeStructurewithCNT);
        for(indexStructure in TreeStructurewithCNT){
          if(TreeStructurewithCNT[indexStructure].text==splitArr[splitArr.length-1] && ParentID==TreeStructurewithCNT[indexStructure].parent){
            if(receiveData.quantifierTerm){
              TreeStructurewithCNT[indexStructure].text += `(${cnt}${receiveData.quantifierTerm})`;

            }else{
              TreeStructurewithCNT[indexStructure].text += `(${cnt}件)`;
            }

          }
        }
      }
      receiveData.TreeStructure = TreeStructurewithCNT;
      initialTreefromTreeStructure(receiveData);

    }

    function openTreeRoot(index){

      $("#CatTree" + index).on('loaded.jstree', function() {
        $("#CatTree" + index).jstree("open_node", $("#0"));
      });
    }

    function openTreeAll(index){
      $("#CatTree" + index).on('loaded.jstree', function() {
        $("#CatTree" + index).jstree('open_all');
      });
    }

    function openTreeTerm(receiveData){

      if(receiveData.openTreeTerm){
        $("#CatTree" + receiveData.id).on('loaded.jstree', function() {
          $("#CatTree" + receiveData.id).jstree(true).search(receiveData.openTreeTerm);
        });
      }

    }

    function receiveMessage( event ) {
  		//console.log( 'receiveMessageData', event.data );
      if(event.data.length==0){
        alert('Error No Tree Data');
        return;
      }


      var buttonHTML = '';
      var TreeHTML = '';
      for(index in event.data){

        var receiveData = event.data[index];
        //console.log(receiveData);
        receiveData.id = index;


        if(receiveData.title){
          buttonHTML += `<button class="controlBtn" type="button" bt="${index}">${receiveData.title}</button>`;
        }
        else{
          buttonHTML += `<button class="controlBtn" type="button" bt="${index}">CatTree Lite ${index}</button>`;
        }

        TreeHTML += `<div class="tree" id="CatTree${index}"></div>`;

      }

      $('#buttonAndTree').append(buttonHTML);
      $('#buttonAndTree').append(TreeHTML);

      for(index in event.data){

        var receiveData = event.data[index];
        receiveData.id = index;

        if(receiveData.DocuSkySearch && receiveData.TreeStructure){
            initialTreefromTreeStructureandDocuSkySearch(receiveData);
        }else if(receiveData.DocuSkySearch){
            initialTreefromDocuSkySearch(receiveData);
        }else if(receiveData.TreeStructure){
            initialTreefromTreeStructure(receiveData);
        }else{
          alert('Error No Tree Data');
        }

        openTreeRoot(receiveData.id);
        if(receiveData.openTreeAll){
          openTreeAll(receiveData.id);
        }


      }

      $('#independentToolModal').modal('hide');
      $('#ShowCSVTable').hide();

      $(".tree").hide();
      $(".controlBtn").hide();
      if(event.data.length == 1){
        $(".tree").show();
      }else{
        $(".controlBtn").show();
        $("#CatTree0").show();
        $(".controlBtn").click(function(){
          var getIndex = $(this).attr('bt');
          $(".tree").hide();
          $("#CatTree"+getIndex).show();
        });

      }
	 }
   window.addEventListener("message", receiveMessage, false);
  </script>

</head>
<body>
  <div class="container">
    <div class="row">
        <div id='buttonAndTree' class="col-xs-3">
        </div>
        <div class="col-xs-1">
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        </div>
        <div id='ShowCSVTable' class="col-xs-8">
          <table id="CSVTable" class="display" style="width:150%">
                  <thead>
                      <tr>
                          <th>Name</th>
                          <th>Position</th>
                          <th>Office</th>
                          <th>Age</th>
                          <th>Start date</th>
                          <th>Salary</th>
                      </tr>
                  </thead>
                  <tbody>
                      <tr>
                          <td>Donna Snider</td>
                          <td>Customer Support</td>
                          <td>New York</td>
                          <td>27</td>
                          <td>2011/01/25</td>
                          <td>$112,000</td>
                      </tr>
                  </tbody>

          </table>
        </div>
    </div>
  </div>

  <!-- The ContactModal -->
  <div class="modal fade" id="independentToolModal">
    <div class="modal-dialog">
      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">CatTree Lite</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          <p>這是一個用來觀察文件分類的工具 (Excel 規範表)</p>
          <div class="input-group">
            <div class="input-group-prepend">
              <span class="input-group-text" id="inputGroupFileAddon01 selectInFile">Upload Excel</span>
            </div>
            <div class="custom-file">
              <input type="file" class="custom-file-input" id="selectInFile" aria-describedby="inputGroupFileAddon01" onchange="xlsxUpload(this)" accept='.xls, .xlsx'>
              <label class="custom-file-label" for="inputGroupFileAddon01">Choose file</label>
            </div>
          </div>

        </div>

        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        </div>

      </div>
    </div>
  </div>
</body>

</html>
